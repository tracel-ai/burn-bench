name: Benchmarks

on:
  workflow_dispatch:
    # note: by design GitHub workflow dispatch events are limited to 10 inputs
    inputs:
      burn_bench_config_json:
        description: "JSON config with backends, benches, dtypes, and versions"
        required: false
        default: '{"backends":["wgpu-fusion"],"benches":["matmul"],"dtypes":["f16"],"versions":["main"]}'
      gcp_gpu_attached:
        description: "Must be true if the machine type has a GPU attached"
        type: boolean
        required: false
        default: true
      gcp_image_family:
        description: "GCP image family to use"
        required: false
        default: "tracel-ci-ubuntu-2404-amd64-nvidia"
      gcp_machine_types:
        description: "Comma-separated GCP machine types"
        required: false
        default: "g2-standard-4"
      gcp_zones:
        description: "Comma-separated GCP zones matching the machine types"
        required: false
        default: "us-east1-c"
      pr_number:
        description: "Number of the pull request that triggers this run if any"
        type: number
        required: false
      repo_full:
        description: "Full repository name, e.g. tracel-ai/burn"
        required: false
        default: "tracel-ai/burn"
      rust_toolchain:
        description: "The Rust toolchain"
        required: false
        default: "stable"
      rust_version:
        description: "The Rust version"
        required: false
        default: "stable"

# important to set the run name to this format so that the CI server
# can track the PR number from the workflow_run events.
run-name: ${{ github.workflow }}:${{ inputs.repo_full }}#${{ inputs.pr_number }}

env:
  INPUTS_FILE: inputs.json

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      repo_owner: ${{ steps.parse-repo.outputs.repo_owner }}
      repo_name:  ${{ steps.parse-repo.outputs.repo_name }}
    steps:
      # we cannot pass repo_full as is because it will be used to tag cloud resources
      # cloud resources can have naming limitations like '/' being forbidden.
      - id: parse-repo
        run: |
          REPO_FULL="${{ inputs.repo_full }}"
          if [[ "$REPO_FULL" =~ ^([^/]+)/([^/]+)$ ]]; then
            echo "repo_owner=${BASH_REMATCH[1]}" >> "$GITHUB_OUTPUT"
            echo "repo_name=${BASH_REMATCH[2]}"  >> "$GITHUB_OUTPUT"
          else
            echo "::error::inputs.repo_full must be 'owner/repo', got: '$REPO_FULL'"
            exit 1
          fi
      - id: set-matrix
        run: |
          MACHINE_TYPES="${{ inputs.gcp_machine_types }}"
          ZONES="${{ inputs.gcp_zones }}"

          IFS=',' read -r -a type_arr <<< "$MACHINE_TYPES"
          IFS=',' read -r -a zones_arr <<< "$ZONES"

          if [ "${#type_arr[@]}" -ne "${#zones_arr[@]}" ]; then
            echo "❌ machine_types and zones count mismatch!" >&2
            exit 1
          fi

          matrix_entries="["
          for i in "${!type_arr[@]}"; do
            machine="${type_arr[$i]}"
            zones="${zones_arr[$i]}"
            matrix_entries+="{\"index\":$i,\"gcp_machine_type\":\"$machine\",\"gcp_zones\":\"$zones\"},"
          done
          matrix_entries="${matrix_entries%,}]"
          echo "matrix=$matrix_entries" >> "$GITHUB_OUTPUT"
  burn-bench:
    needs: prepare
    timeout-minutes: 120
    strategy:
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: [
      '@id:benchmarks-job-${{ github.run_id }}-${{ matrix.index }}-${{ github.run_attempt }}',
      '@pr_number:${{ inputs.pr_number }}',
      '@organization:${{ needs.prepare.outputs.repo_owner }}',
      '@repository:${{ needs.prepare.outputs.repo_name }}',
      '@image-family:${{ inputs.gcp_image_family }}',
      '@machine-type:${{ matrix.gcp_machine_type }}',
      '@zones:${{ matrix.gcp_zones }}',
      '@gpu:${{ inputs.gcp_gpu_attached }}' ]
    steps:
      # ----------------------------------------------------------------------
      - name: Setup Rust
        uses: tracel-ai/github-actions/setup-rust@v3
        with:
          rust-toolchain: ${{ inputs.rust_toolchain }}
          cache-key: ${{ inputs.rust_version }}-benchmarks
      - name: Parse config
        id: burn_bench_config_json
        run: |
          echo '${{ inputs.burn_bench_config_json }}' > config.json
          echo "BACKENDS=$(jq -r '.backends | join(" ")' config.json)" >> $GITHUB_ENV
          echo "BENCHES=$(jq -r '.benches | join(" ")' config.json)" >> $GITHUB_ENV
          echo "DTYPES=$(jq -r '.dtypes | join(" ")' config.json)" >> $GITHUB_ENV
          echo "VERSIONS=$(jq -r '.versions | join(" ")' config.json)" >> $GITHUB_ENV
      # ----------------------------------------------------------------------
      - name: Print configuration
        run: |
          echo "Versions: $VERSIONS"
          echo "Backends: $BACKENDS"
          echo "DTypes: $DTYPES"
          echo "Benchmarks: $BENCHES"
          echo "Repository: ${{ inputs.repo_full }}"
          echo "Pull Request Number: ${{ inputs.pr_number }}"
          echo "GCP Image Family: ${{ inputs.gcp_image_family }}"
          echo "GCP Machine Type: ${{ matrix.gcp_machine_type }}"
          echo "GCP Zones: ${{ matrix.gcp_zones }}"
      # ----------------------------------------------------------------------
      - name: Write inputs to ${{ env.INPUTS_FILE }}
        run: |
          PR_NUMBER_INPUT='${{ inputs.pr_number }}'
          if [[ -z "$PR_NUMBER_INPUT" ]]; then
            PR_NUMBER_JSON=null
          else
            PR_NUMBER_JSON="$PR_NUMBER_INPUT"
          fi

          jq -n \
            --arg burn_bench_config_json '${{ inputs.burn_bench_config_json }}' \
            --argjson gcp_gpu_attached '${{ inputs.gcp_gpu_attached }}' \
            --arg gcp_image_family '${{ inputs.gcp_image_family }}' \
            --arg gcp_machine_type '${{ matrix.gcp_machine_type }}' \
            --arg gcp_zones '${{ matrix.gcp_zones }}' \
            --argjson pr_number "$PR_NUMBER_JSON" \
            --arg repo_full '${{ inputs.repo_full }}' \
            --arg rust_toolchain '${{ inputs.rust_toolchain }}' \
            --arg rust_version '${{ inputs.rust_version }}' \
            --arg workflow_url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '{
              burn_bench_config_json: $burn_bench_config_json,
              gcp_gpu_attached: $gcp_gpu_attached,
              gcp_image_family: $gcp_image_family,
              gcp_machine_type: $gcp_machine_type,
              gcp_zones: $gcp_zones,
              pr_number: $pr_number,
              repo_full: $repo_full,
              rust_toolchain: $rust_toolchain,
              rust_version: $rust_version,
              workflow_url: $workflow_url
            }' > "$INPUTS_FILE"

            cat "$INPUTS_FILE"
      # ----------------------------------------------------------------------
      - name: 🧪 Run benchmarks on machine ${{ matrix.index }} (${{matrix.gcp_machine_type }})
        env:
          GITHUB_BOT_TOKEN: ${{ secrets.GH_BOT_TOKEN }}
          WEBHOOK_INPUTS_FILE: ${{ env.INPUTS_FILE }}
          WEBHOOK_PAYLOAD_SECRET: ${{ secrets.WEBHOOK_PAYLOAD_SECRET }}
        run: |
          cargo bb run -b $BENCHES -B $BACKENDS -V $VERSIONS -v -d $DTYPES --share
